/*
 * Copyright (c) 2018 PIXILAB Technologies AB, Sweden (http://pixilab.se). All Rights Reserved.
 */

import {NetworkTCP} from "system/Network";
import {Driver} from "system_lib/Driver";
import {callable, driver, max, min, parameter, property} from "system_lib/Metadata";

/**	Basic driver for sending keystrokes through a Global Cach√© iTach
	Ethernet IR sender.
*/
@driver('NetworkTCP', { port: 4998 })
export class iTachIR extends Driver<NetworkTCP> {
	private currChannel: number = 0;	// Out-of-range, but well defined, value

	public constructor(private socket: NetworkTCP) {
		super(socket);
		socket.autoConnect();
	}

	@callable("Send a single key-press")
	public sendKey(
		@parameter("Key to send") key: string
	) {
		const toSend = keyToCode[key];
		if (toSend)
			this.socket.sendText(toSend);
		else
			console.warn("Undefined key", key);
	}

	@property("TV channel number")
	@min(1) @max(99)
	public set channel(channel: number) {
		this.currChannel = channel;
		if (channel > 9)
			this.sendKey(Math.floor(channel / 10).toString());
		this.sendKey((channel % 10).toString());
		this.sendKey("OK");		// Speeds up channel access somewhat
	}

	public get channel() {
		return this.currChannel;
	}

}

// A simple typed dictionary type, using a string as key
interface Dictionary<TElem> {
	[id: string]: TElem;
}

// Key codes learnt from the TV box remote through the iTach box
var keyToCode: Dictionary<string> = {
	"0": "sendir,2:1,3,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,9,10,19,10,9,20,9,10,9,10,9,10,9,10,19,10,9,20,2887,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,9,10,19,10,9,20,9,10,9,10,9,10,19,20,19,20,4651",
	"1": "sendir,2:1,4,36231,1,1,70,54,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,10,9,20,19,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,4637",
	"2": "sendir,2:1,5,36231,1,1,70,54,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,10,9,10,10,9,10,9,20,9,10,9,10,9,10,9,10,9,10,19,10,9,10,9,10,9,10,2874,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,10,10,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,19,10,9,10,4637",
	"3": "sendir,2:1,1,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,19,10,9,20,9,10,9,10,9,10,9,10,9,10,19,20,4651",
	"4": "sendir,2:1,7,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,19,20,9,10,9,10,9,10,9,10,19,10,9,20,19,10,2885,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,19,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,19,10,2883,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,10,10,9,20,19,10,9,10,9,10,9,10,9,20,19,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,19,10,4651",
	"5": "sendir,2:1,8,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,19,20,9,10,9,10,9,10,19,10,9,20,9,10,2894,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,19,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,2883,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,19,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,2883,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,19,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,2883,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,19,20,9,10,9,10,9,10,9,10,9,10,9,10,9,10,4651",
	"6": "sendir,2:1,9,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,9,10,9,10,9,10,9,10,9,10,19,20,19,10,9,10,2886,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,9,10,9,10,9,10,9,10,9,10,19,10,9,10,9,10,9,10,2884,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,9,10,9,10,9,10,9,10,9,10,19,10,9,10,9,10,9,10,2883,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,10,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,9,10,9,10,9,10,9,10,9,10,19,10,9,10,9,10,9,10,2884,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,10,9,20,9,10,9,10,9,10,9,10,9,10,9,10,19,10,9,10,9,10,9,10,4651",
	"7": "sendir,2:1,10,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,10,9,10,9,20,9,10,9,10,9,10,19,20,19,20,2894,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,10,9,10,9,20,9,10,9,10,9,10,19,10,9,10,9,20,2883,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,10,9,10,10,19,10,10,9,10,9,10,19,10,9,10,9,20,2883,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,10,9,10,9,20,9,10,9,10,9,10,19,10,9,10,9,20,4651",
	"8": "sendir,2:1,11,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,10,9,20,9,10,9,10,9,10,9,10,19,20,9,10,19,10,2882,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,10,9,20,9,10,9,10,9,10,9,10,19,10,9,20,19,10,2884,70,54,30,9,10,9,10,10,9,10,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,10,9,20,9,10,9,10,9,10,9,10,19,10,9,20,19,10,2884,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,10,9,10,20,19,10,9,20,9,10,9,10,9,10,9,10,19,10,9,20,19,10,4651",
	"9": "sendir,2:1,14,36337,1,1,70,55,30,9,10,9,10,9,10,9,20,9,10,19,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,20,19,20,9,10,9,10,9,10,19,20,9,10,9,10,2891,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,20,19,20,9,10,9,10,9,10,19,10,9,20,9,10,2884,70,54,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,10,9,20,19,20,19,20,9,10,9,10,9,10,19,10,9,20,9,10,4651",
	"OK": "sendir,2:1,3,36337,1,1,16,19,20,2899,70,55,30,9,10,9,10,9,10,9,20,19,10,9,20,19,10,9,10,9,10,9,10,9,10,9,10,9,20,19,10,9,10,9,20,19,20,9,10,9,10,9,10,9,10,9,10,9,10,19,10,9,10,9,20,4651"
}

